<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Orchan&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="喜欢摄影、折腾数码产品，目前是一个iOS Developer">
<meta property="og:type" content="website">
<meta property="og:title" content="Orchan's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Orchan's Blog">
<meta property="og:description" content="喜欢摄影、折腾数码产品，目前是一个iOS Developer">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Orchan's Blog">
<meta name="twitter:description" content="喜欢摄影、折腾数码产品，目前是一个iOS Developer">
  
    <link rel="alternative" href="/atom.xml" title="Orchan&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xkf7q.com1.z0.glb.clouddn.com/16-2-21/41492850.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Orchan</a></h1>
		</hgroup>

		
		<p class="header-subtitle">多看源码，多动手撸码</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>標籤</li>
						
						
						<li>關於</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/iOS">iOS</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/orchan" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/kezhenthink" title="weibo">weibo</a>
					        
								<a class="mail" target="_blank" href="/kezhenbl@live.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/iOS/" style="font-size: 10px;">iOS</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">目前是一名iOS开发攻城狮，就职于惠州市德赛工业研究院。</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Orchan</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://7xkf7q.com1.z0.glb.clouddn.com/16-2-21/41492850.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Orchan</h1>
			</hgroup>
			
			<p class="header-subtitle">多看源码，多动手撸码</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/iOS">iOS</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/orchan" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/kezhenthink" title="weibo">weibo</a>
			        
						<a class="mail" target="_blank" href="/kezhenbl@live.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-Masonry使用总结" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/22/Masonry使用总结/" class="article-date">
  	<time datetime="2016-02-22T01:25:25.000Z" itemprop="datePublished">2016-02-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/22/Masonry使用总结/">Masonry使用总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一、Masonry简介"><a href="#一、Masonry简介" class="headerlink" title="一、Masonry简介"></a>一、Masonry简介</h3><blockquote>
<p>Masonry是一个轻量级的布局框架，适用于<code>iOS</code>以及<code>OS X</code>。它用简洁的语法对官方的<code>AutoLayout</code>进行了封装。 Masonry有它自己的一套框架用来描述<code>NSLayoutConstraints</code>布局的<code>DSL</code>，提高了约束代码的简洁性与可读性。<br><em>Masonry现处于<code>bugfix only</code>状态，将不再有功能性的更新。会有更多的开发者加入<code>Swift</code>阵营，推荐使用Swift写的<code>Snapkit</code>框架来布局。</em></p>
</blockquote>
<p><img src="http://7xkf7q.com1.z0.glb.clouddn.com/15-8-6/61491985.jpg" alt="snapkit"></p>
<hr>
<h3 id="二、导入Masonry框架"><a href="#二、导入Masonry框架" class="headerlink" title="二、导入Masonry框架"></a>二、导入<em>Masonry</em>框架</h3><ol>
<li>使用<code>Cocoapods</code>来导入框架，在使用到该框架的文件中添加主头文件：<code>#import &lt;Masonry/Masonry.h&gt;</code>。</li>
</ol>
<ul>
<li>可以参考这篇文章来配置使用<code>Cocoapods</code> – &gt; <a href="http://code4app.com/article/cocoapods-install-usage" target="_blank" rel="external">Cocoapods的安装和使用</a></li>
</ul>
<ol>
<li>使用直接拖拽的方式拉入框架文件夹，在使用到该框架的文件中添加主头文件：<code>#import &quot;Masonry.h&quot;</code>。</li>
</ol>
<hr>
<h3 id="三、Masonry的特性"><a href="#三、Masonry的特性" class="headerlink" title="三、Masonry的特性"></a>三、Masonry的特性</h3><ol>
<li><p><em>MASViewAttribute</em><br>|MASViewAttribute   |NSLayoutAttribute<br>|:—-:             |:—-:<br>|MASViewAttribute   |NSLayoutAttribute<br>|view.mas_left      |NSLayoutAttributeLeft<br>|view.mas_right     |NSLayoutAttributeRight<br>|view.mas_top        |NSLayoutAttributeTop<br>|view.mas_bottom    |NSLayoutAttributeBottom<br>|view.mas_leading    |NSLayoutAttributeLeading<br>|view.mas_trailing    |NSLayoutAttributeTrailing<br>|view.mas_width        |NSLayoutAttributeWidth<br>|view.mas_height    |NSLayoutAttributeHeight<br>|view.mas_centerX    |NSLayoutAttributeCenterX<br>|view.mas_centerY    |NSLayoutAttributeCenterY<br>|view.mas_baseline    |NSLayoutAttributeBaseline</p>
</li>
<li><p><em>简化前缀的宏定义</em></p>
</li>
</ol>
<ul>
<li>为了增加代码的可读性这里有两个简化代码的宏：<code>#define MAS_SHORTHAND</code>和#<code>define MAS_SHORTHAND_GLOBALS</code></li>
<li><code>MAS_SHORTHAND</code>：只要在导入<code>Masonry</code>主头文件之前定义这个宏, 那么以后在使用<code>Masonry</code>框架中的属性和方法的时候, 就可以省略<code>mas_</code>前缀</li>
<li><code>MAS_SHORTHAND_GLOBALS</code>：只要在导入<code>Masonry</code>主头文件之前定义这个宏,那么就可以让<code>equalTo</code>函数接收基本数据类型, 内部会对基本数据类型进行包装<br>注意：这两个宏如果想有效使用，必须要在添加<code>Masonry</code>头文件之前导入进去。在没有增加宏`MAS_SHORTHAND_GLOBALS时，下面这句是会报错的。<br><del>make.top.equalTo(42);</del> –&gt; make.top.equalTo([NSNumber numberWithInt:42]);</li>
</ul>
<hr>
<h3 id="四、Masonry约束添加步骤"><a href="#四、Masonry约束添加步骤" class="headerlink" title="四、Masonry约束添加步骤"></a>四、<em>Masonry</em>约束添加步骤</h3><ol>
<li>自定义<code>UIView</code>。</li>
<li>将自定义的<code>UIView</code>添加到父视图上。</li>
<li>添加约束</li>
</ol>
<hr>
<h3 id="五、Masonry的具体使用"><a href="#五、Masonry的具体使用" class="headerlink" title="五、Masonry的具体使用"></a>五、<code>Masonry</code>的具体使用</h3><blockquote>
<p>对一个控件添加约束条件要最终满足可以确定这个空间的大小和位置，否则会报错缺少约束，当然也要避免约束冲突。下面对<code>View1</code>的左右上下（位置）都进行约束，并没有对其大小进行约束，但是可根据上述约束自动设置<code>View1</code>的大小。</p>
</blockquote>
<h4 id="1-创建一个View，左右上下空出10个像素"><a href="#1-创建一个View，左右上下空出10个像素" class="headerlink" title="1. 创建一个View，左右上下空出10个像素"></a>1. 创建一个View，左右上下空出10个像素</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UIView *view1 = [[UIView alloc]init];&#10;&#10;view1.backgroundColor = [UIColor greenColor];&#10;&#10;[self.view addSubview:view1];&#10;&#10;UIEdgeInsets padding = UIEdgeInsetsMake(150, 30, 30, 30);&#10;&#10;[view1 mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.top.equalTo(self.view.mas_top).with.offset(padding.top);&#10;make.left.equalTo(self.view.mas_left).with.offset(padding.left);&#10;make.bottom.equalTo(self.view.mas_bottom).with.offset(-padding.bottom);&#10;make.right.equalTo(self.view.mas_right).with.offset(-padding.right);&#10;&#125;];&#10;&#10;// &#19968;&#21477;&#20195;&#30721;&#20195;&#26367;&#19978;&#38754;&#30340;&#22810;&#34892;&#10;//    [view1 mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;//        make.edges.equalTo(self.view).with.insets(UIEdgeInsetsMake(150, 30, 30, 30));&#10;//    &#125;];</span><br></pre></td></tr></table></figure>
<h4 id="2-使用Priority属性来做简单的动画"><a href="#2-使用Priority属性来做简单的动画" class="headerlink" title="2. 使用Priority属性来做简单的动画"></a>2. 使用<code>Priority</code>属性来做简单的动画</h4><p><code>.priority</code> allows you to specify an exact priority</p>
<p><code>.priorityHigh</code> equivalent to <code>UILayoutPriorityDefaultHigh</code></p>
<p><code>.priorityMedium</code> is half way between high and low</p>
<p><code>.priorityLow</code> equivalent to <code>UILayoutPriorityDefaultLow</code></p>
<ul>
<li>优先级约束一般放在一个控件约束的最后面，下面看示例。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// &#32418;&#33394;View&#10;UIView *redView = [[UIView alloc]init];&#10;redView.backgroundColor = [UIColor redColor];&#10;[self.view addSubview:redView];&#10;&#10;// &#34013;&#33394;View&#10;self.blueView = [[UIView alloc]init];&#10;self.blueView.backgroundColor = [UIColor blueColor];&#10;[self.view addSubview:self.blueView];&#10;&#10;// &#40644;&#33394;View&#10;UIView *yellowView = [[UIView alloc]init];&#10;yellowView.backgroundColor = [UIColor yellowColor];&#10;[self.view addSubview:yellowView];&#10;&#10;// ---&#32418;&#33394;View--- &#28155;&#21152;&#32422;&#26463;&#10;[redView mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.left.mas_equalTo(self.view.mas_left).with.offset(20);&#10;make.bottom.mas_equalTo(self.view.mas_bottom).with.offset(-80);&#10;make.height.equalTo([NSNumber numberWithInt:50]);&#10;&#125;];&#10;&#10;// ---&#34013;&#33394;View--- &#28155;&#21152;&#32422;&#26463;&#10;[self.blueView mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.left.mas_equalTo(redView.mas_right).with.offset(40);&#10;make.bottom.width.height.mas_equalTo(redView);&#10;&#125;];&#10;&#10;// ---&#40644;&#33394;View--- &#28155;&#21152;&#32422;&#26463;&#10;[yellowView mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.left.mas_equalTo(self.blueView.mas_right).with.offset(40);&#10;make.right.mas_equalTo(self.view.mas_right).with.offset(-20);&#10;make.bottom.width.height.mas_equalTo(redView);&#10;&#10;// &#20248;&#20808;&#32423;&#35774;&#32622;&#20026;250&#65292;&#26368;&#39640;1000&#65288;&#40664;&#35748;&#65289;&#10;make.left.mas_equalTo(redView.mas_right).with.offset(20).priority(250);&#10;&#125;];</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://img-storage.qiniudn.com/15-8-6/12947572.jpg" alt="Masonry动画1"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// &#28857;&#20987;&#23631;&#24149;&#31227;&#38500;&#34013;&#33394;View&#10;- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event&#10;&#123;&#10;[self.blueView removeFromSuperview];&#10;[UIView animateWithDuration:1.0 animations:^&#123;&#10;[self.view layoutIfNeeded];&#10;&#125;];&#10;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://img-storage.qiniudn.com/15-8-6/35877219.jpg" alt="Masonry动画2"></p>
<blockquote>
<p>解：这里的三个View的宽度是根据约束自动推断设置的，对黄色的View设置了一个与红色View有关的<code>priority(250)</code>的优先级，它同时有对蓝色View有个最高的优先级约束（<code>make.left.mas_equalTo(self.blueView.mas_right).with.offset(40);</code>）。当点击屏幕是，我将蓝色View移除，此时第二优先级就是生效。</p>
</blockquote>
<h4 id="3-Masonry官方Demo之Basic"><a href="#3-Masonry官方Demo之Basic" class="headerlink" title="3. Masonry官方Demo之Basic"></a>3. Masonry官方Demo之<code>Basic</code></h4><p><img src="http://7xkf7q.com1.z0.glb.clouddn.com/15-8-7/17124843.jpg" alt="basic1"></p>
<p><img src="http://7xkf7q.com1.z0.glb.clouddn.com/15-8-7/75476037.jpg" alt="basic2"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)testBasic&#10;&#123;&#10;int padding = 15;&#10;&#10;UIView *greenView = [[UIView alloc]init];&#10;[self.view addSubview:greenView];&#10;greenView.backgroundColor = [UIColor greenColor];&#10;&#10;UIView *redView = [[UIView alloc]init];&#10;[self.view addSubview:redView];&#10;redView.backgroundColor = [UIColor redColor];&#10;&#10;UIView *blueView = [[UIView alloc]init];&#10;[self.view addSubview:blueView];&#10;blueView.backgroundColor = [UIColor blueColor];&#10;&#10;// &#23545; &#32511;&#33394;View &#36827;&#34892;&#32422;&#26463;&#10;[greenView mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.left.mas_equalTo(self.view.mas_left).with.offset(padding); // X&#10;&#10;make.top.mas_equalTo(self.view.mas_top).with.offset(padding); // Y&#10;make.bottom.mas_equalTo(blueView.mas_top).with.offset(-padding);// Y --&#62; &#25512;&#26029;&#20986; Height&#10;&#10;make.width.mas_equalTo(redView); // Width == &#32418;&#33394;View&#65288;&#23427;&#25512;&#26029;&#20986;Width&#65289;&#10;&#125;];&#10;&#10;// &#23545; &#32418;&#33394;View &#36827;&#34892;&#32422;&#26463;&#10;[redView mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.left.mas_equalTo(greenView.mas_right).with.offset(padding); // X&#10;make.right.mas_equalTo(self.view.mas_right).with.offset(-padding);// X --&#62; &#25512;&#26029;&#20986; Width&#10;&#10;make.bottom.and.height.mas_equalTo(greenView); // Y &#38; Height == &#32511;&#33394;View&#65288;&#23427;&#25512;&#26029;&#20986; Height&#38;Y&#65289;&#10;&#125;];&#10;&#10;// &#23545; &#34013;&#33394;View &#36827;&#34892;&#32422;&#26463;&#10;[blueView mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.left.mas_equalTo(self.view.mas_left).with.offset(padding); // X&#10;make.right.mas_equalTo(self.view.mas_right).with.offset(-padding); // X --&#62; &#25512;&#26029;&#20986; Width&#10;&#10;make.bottom.mas_equalTo(self.view.mas_bottom).with.offset(-padding); // Y&#10;&#10;make.height.mas_equalTo(greenView); // &#27880;&#24847;1&#65306;Height == &#32511;&#33394;View&#65288;&#23427;&#25512;&#26029;&#20986;Height&#65289;&#10;&#125;];&#10;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>总结：对<code>绿色View</code>约束了距离<code>左边</code>的距离（即确定了<code>X值</code>），约束了距离<code>顶部</code>和<code>底部蓝色View</code>的距离（这里有个坑需要注意，很多人会认为约束了这两个就能推断出<code>Height</code>，其实是错误的。除非<code>蓝色View</code>添加一个约束让它们俩<code>高度相同</code>，否则即便知道了它们<code>俩间距</code>和分别对<code>顶部</code>和<code>底部</code>的距离，也不知道<code>红色View</code>和<code>蓝色View</code>高度如何。）</p>
<p>口诀：谁推断出大小位置（一或多），与其有约束关系的View的大小位置（一或多）向它看齐。</p>
</blockquote>
<h4 id="4-Masonry的更新约束-mas-updateConstraints"><a href="#4-Masonry的更新约束-mas-updateConstraints" class="headerlink" title="4. Masonry的更新约束 mas_updateConstraints"></a>4. Masonry的更新约束 <code>mas_updateConstraints</code></h4><blockquote>
<p>Alternatively if you are only updating the constant value of the constraint you can use the convience method <code>mas_updateConstraints</code> instead of <code>mas_makeConstraints</code></p>
</blockquote>
<p>创建一个按钮，约束好它的位置（居中，宽高等于100且小于屏幕宽高值）。每次点击一次这个按钮，其宽高将增大一定的倍数，最终其宽高等于屏幕宽高时将不再变化。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@interface ViewController ()&#10;@property (nonatomic, strong) UIButton *growingButton;&#10;@property (nonatomic, assign) CGFloat scacle;&#10;@end</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)createGrowingButton &#123;&#10;self.growingButton = [UIButton buttonWithType:UIButtonTypeSystem];&#10;&#10;[self.growingButton setTitle:@&#34;&#28857;&#25105;&#25918;&#22823;&#34; forState:UIControlStateNormal];&#10;&#10;self.growingButton.layer.borderColor = UIColor.greenColor.CGColor;&#10;&#10;self.growingButton.layer.borderWidth = 3;&#10;&#10;[self.growingButton addTarget:self action:@selector(onGrowButtonTaped:) forControlEvents:UIControlEventTouchUpInside];&#10;&#10;[self.view addSubview:self.growingButton];&#10;self.scacle = 1.0;&#10;&#10;[self.growingButton mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.center.mas_equalTo(self.view);&#10;&#10;// &#21021;&#22987;&#23485;&#12289;&#39640;&#20026;100&#65292;&#20248;&#20808;&#32423;&#26368;&#20302;&#10;make.width.height.mas_equalTo(100 * self.scacle);&#10;&#10;// &#26368;&#22823;&#25918;&#22823;&#21040;&#25972;&#20010;view&#10;make.width.height.lessThanOrEqualTo(self.view);&#10;&#125;];    &#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)onGrowButtonTaped:(UIButton *)sender &#123;&#10;self.scacle += 1.0;&#10;&#10;// &#21578;&#35785;self.view&#32422;&#26463;&#38656;&#35201;&#26356;&#26032;&#10;[self.view setNeedsUpdateConstraints];&#10;&#10;// &#35843;&#29992;&#27492;&#26041;&#27861;&#21578;&#35785;self.view&#26816;&#27979;&#26159;&#21542;&#38656;&#35201;&#26356;&#26032;&#32422;&#26463;&#65292;&#33509;&#38656;&#35201;&#21017;&#26356;&#26032;&#65292;&#19979;&#38754;&#28155;&#21152;&#21160;&#30011;&#25928;&#26524;&#25165;&#36215;&#20316;&#29992;&#10;&#10;[self.view updateConstraintsIfNeeded];&#10;&#10;[UIView animateWithDuration:0.3 animations:^&#123;&#10;[self.view layoutIfNeeded];&#10;&#125;];&#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - updateViewConstraints&#10;// &#37325;&#20889;&#35813;&#26041;&#27861;&#26469;&#26356;&#26032;&#32422;&#26463;&#10;- (void)updateViewConstraints &#123;&#10;[self.growingButton mas_updateConstraints:^(MASConstraintMaker *make) &#123;&#10;// &#36825;&#37324;&#20889;&#38656;&#35201;&#26356;&#26032;&#30340;&#32422;&#26463;&#65292;&#19981;&#29992;&#26356;&#26032;&#30340;&#32422;&#26463;&#23558;&#32487;&#32493;&#23384;&#22312;&#10;// &#19981;&#20250;&#34987;&#21462;&#20195;&#65292;&#22914;&#65306;&#20854;&#23485;&#39640;&#23567;&#20110;&#23631;&#24149;&#23485;&#39640;&#19981;&#38656;&#35201;&#37325;&#26032;&#20877;&#32422;&#26463;&#10;make.width.height.mas_equalTo(100 * self.scacle);&#10;&#125;];&#10;&#10;[super updateViewConstraints];&#10;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://7xkf7q.com1.z0.glb.clouddn.com/16-1-18/47326134.jpg" alt="更新约束"></p>
<h4 id="5-Masonry的重写约束-mas-remakeConstraints"><a href="#5-Masonry的重写约束-mas-remakeConstraints" class="headerlink" title="5. Masonry的重写约束 mas_remakeConstraints"></a>5. Masonry的重写约束 <code>mas_remakeConstraints</code></h4><blockquote>
<p>Creates a MASConstraintMaker with the callee view. Any constraints defined are added to the view or the appropriate superview once the block has finished executing. All constraints previously installed for the view will be removed.</p>
</blockquote>
<p>创建一个按钮，约束好其位置（与屏幕上左右的距离为0，与屏幕底部距离为350），点击按钮后全屏展现（即与屏幕底部距离为0）。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, strong) UIButton *growingButton;&#10;@property (nonatomic, assign) BOOL isExpanded;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)createExpandButton &#123;&#10;self.isExpanded = NO;&#10;self.growingButton = [UIButton buttonWithType:UIButtonTypeSystem];&#10;[self.growingButton setTitle:@&#34;&#28857;&#25105;&#23637;&#24320;&#34; forState:UIControlStateNormal];&#10;self.growingButton.layer.borderColor = UIColor.greenColor.CGColor;&#10;self.growingButton.layer.borderWidth = 3;&#10;self.growingButton.backgroundColor = [UIColor redColor];&#10;[self.growingButton addTarget:self action:@selector(onGrowButtonTaped:) forControlEvents:UIControlEventTouchUpInside];&#10;[self.view addSubview:self.growingButton];&#10;[self.growingButton mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.top.mas_equalTo(0);&#10;make.left.right.mas_equalTo(0);&#10;make.bottom.mas_equalTo(-350);&#10;&#125;];&#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - updateViewConstraints&#10;- (void)updateViewConstraints &#123;&#10;// &#36825;&#37324;&#20351;&#29992;update&#20063;&#33021;&#23454;&#29616;&#25928;&#26524;&#10;// remake&#20250;&#23558;&#20043;&#21069;&#30340;&#20840;&#37096;&#31227;&#38500;&#65292;&#28982;&#21518;&#37325;&#26032;&#28155;&#21152;&#10;__weak __typeof(self) weakSelf = self;&#10;[self.growingButton mas_remakeConstraints:^(MASConstraintMaker *make) &#123;&#10;// &#36825;&#37324;&#37325;&#20889;&#20840;&#37096;&#32422;&#26463;&#65292;&#20043;&#21069;&#30340;&#32422;&#26463;&#37117;&#23558;&#22833;&#25928;&#10;make.top.mas_equalTo(0);&#10;make.left.right.mas_equalTo(0);&#10;if (weakSelf.isExpanded) &#123;&#10;make.bottom.mas_equalTo(0);&#10;&#125; else &#123;&#10;make.bottom.mas_equalTo(-350);&#10;&#125;&#10;&#125;];&#10;[super updateViewConstraints];&#10;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)onGrowButtonTaped:(UIButton *)sender &#123;&#10;self.isExpanded = !self.isExpanded;&#10;if (!self.isExpanded) &#123;&#10;[self.growingButton setTitle:@&#34;&#28857;&#25105;&#23637;&#24320;&#34; forState:UIControlStateNormal];&#10;&#125; else &#123;&#10;[self.growingButton setTitle:@&#34;&#28857;&#25105;&#25910;&#36215;&#34; forState:UIControlStateNormal];&#10;&#125;&#10;// &#21578;&#35785;self.view&#32422;&#26463;&#38656;&#35201;&#26356;&#26032;&#10;[self.view setNeedsUpdateConstraints];&#10;// &#35843;&#29992;&#27492;&#26041;&#27861;&#21578;&#35785;self.view&#26816;&#27979;&#26159;&#21542;&#38656;&#35201;&#26356;&#26032;&#32422;&#26463;&#65292;&#33509;&#38656;&#35201;&#21017;&#26356;&#26032;&#65292;&#19979;&#38754;&#28155;&#21152;&#21160;&#30011;&#25928;&#26524;&#25165;&#36215;&#20316;&#29992;&#10;[self.view updateConstraintsIfNeeded];&#10;&#10;[UIView animateWithDuration:0.3 animations:^&#123;&#10;[self.view layoutIfNeeded];&#10;&#125;];&#10;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>mas_remakeConstraints</code>和 <code>mas_updateConstraints</code> 的区别在于前者重新对视图进行了约束（抛弃了之前的约束），后者是更新约束条件（保留未更新的约束，如：这次更新了对 <code>height</code> 的约束，其他对X&amp;Y以及宽的约束不变）。</li>
</ul>
<p><img src="http://7xkf7q.com1.z0.glb.clouddn.com/16-1-18/70206448.jpg" alt="重写约束1"></p>
<p><img src="http://7xkf7q.com1.z0.glb.clouddn.com/16-1-18/26993923.jpg" alt="重写约束2"></p>
<h4 id="6-Masonry的比例使用-multipliedBy"><a href="#6-Masonry的比例使用-multipliedBy" class="headerlink" title="6. Masonry的比例使用 multipliedBy"></a>6. Masonry的比例使用 <code>multipliedBy</code></h4><blockquote>
<p>使用multipliedBy必须是对同一个控件本身，如果修改成相对于其它控件会出导致Crash。</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UIView *topView = [[UIView alloc]init];&#10;[topView setBackgroundColor:[UIColor redColor]];&#10;[self.view addSubview:topView];&#10;&#10;UIView *topInnerView = [[UIView alloc]init];&#10;[topInnerView setBackgroundColor:[UIColor greenColor]];&#10;[topView addSubview:topInnerView];&#10;&#10;UIView *bottomView = [[UIView alloc]init];&#10;[bottomView setBackgroundColor:[UIColor orangeColor]];&#10;[self.view addSubview:bottomView];&#10;&#10;UIView *bottomInnerView = [[UIView alloc]init];&#10;[bottomInnerView setBackgroundColor:[UIColor blueColor]];&#10;[bottomView addSubview:bottomInnerView];&#10;&#10;[topView mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.top.left.right.mas_equalTo(0);&#10;make.height.mas_equalTo(bottomView);&#10;&#125;];&#10;&#10;[topInnerView mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.left.right.mas_equalTo(0);&#10;make.width.mas_equalTo(topInnerView.mas_height).multipliedBy(3);&#10;make.center.mas_equalTo(topView);&#10;&#125;];&#10;&#10;[bottomView mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.left.bottom.right.mas_equalTo(0);&#10;make.height.mas_equalTo(topView);&#10;make.top.mas_equalTo(topView.mas_bottom);&#10;&#125;];&#10;&#10;[bottomInnerView mas_makeConstraints:^(MASConstraintMaker *make) &#123;&#10;make.top.bottom.mas_equalTo(bottomView);&#10;make.height.mas_equalTo(bottomInnerView.mas_width).multipliedBy(3);&#10;make.center.mas_equalTo(bottomView);&#10;&#125;];</span><br></pre></td></tr></table></figure>
<p><img src="http://7xkf7q.com1.z0.glb.clouddn.com/16-1-18/16598571.jpg" alt="multiply"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Masonry-Autolayout/">Masonry, Autolayout</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-iOS音频播放的几种方式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/22/iOS音频播放的几种方式/" class="article-date">
  	<time datetime="2016-02-22T01:23:10.000Z" itemprop="datePublished">2016-02-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/22/iOS音频播放的几种方式/">iOS音频播放的几种方式</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、使用AVAudioPlayer播放音乐"><a href="#一、使用AVAudioPlayer播放音乐" class="headerlink" title="一、使用AVAudioPlayer播放音乐"></a>一、<strong>使用AVAudioPlayer播放音乐</strong></h2><h3 id="1-Background-Modes"><a href="#1-Background-Modes" class="headerlink" title="1. Background Modes"></a>1. Background Modes</h3><p>打开后台模式的音乐播放，或者在info.plist文件中添加<code>Required Background Modes</code>键，其值是<code>App plays audio or streams audio/video using AirPlay</code></p>
<p><img src="http://7xkf7q.com1.z0.glb.clouddn.com/15-7-27/35237232.jpg" alt="Background Modes"></p>
<h3 id="2-添加后台播放代码"><a href="#2-添加后台播放代码" class="headerlink" title="2. 添加后台播放代码"></a>2. 添加后台播放代码</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVAudioSession</span> *session = [<span class="built_in">AVAudioSession</span> sharedInstance];</span><br><span class="line"></span><br><span class="line">[session setActive:<span class="literal">YES</span> error:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">[session setCategory:<span class="built_in">AVAudioSessionCategoryPlayback</span> error:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<h3 id="3-播放指定的音频文件"><a href="#3-播放指定的音频文件" class="headerlink" title="3. 播放指定的音频文件"></a>3. 播放指定的音频文件</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.获取要播放音频文件的URL</span></span><br><span class="line"><span class="built_in">NSURL</span> *fileURL = [[<span class="built_in">NSBundle</span> mainBundle]URLForResource:<span class="string">@"王力宏-流泪手心"</span> withExtension:<span class="string">@".mp3"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.创建 AVAudioPlayer 对象</span></span><br><span class="line"><span class="keyword">self</span><span class="variable">.audioPlayer</span> = [[<span class="built_in">AVAudioPlayer</span> alloc]initWithContentsOfURL:fileURL error:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.打印歌曲信息</span></span><br><span class="line"><span class="built_in">NSString</span> *msg = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"音频文件声道数:%ld\n 音频文件持续时间:%g"</span>,<span class="keyword">self</span><span class="variable">.audioPlayer</span><span class="variable">.numberOfChannels</span>,<span class="keyword">self</span><span class="variable">.audioPlayer</span><span class="variable">.duration</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,msg);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.设置循环播放</span></span><br><span class="line"><span class="keyword">self</span><span class="variable">.audioPlayer</span><span class="variable">.numberOfLoops</span> = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">self</span><span class="variable">.audioPlayer</span><span class="variable">.delegate</span> = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.开始播放</span></span><br><span class="line">[<span class="keyword">self</span><span class="variable">.audioplayer</span> play];</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="二、使用System-Sound-Services播放音频"><a href="#二、使用System-Sound-Services播放音频" class="headerlink" title="二、使用System Sound Services播放音频"></a>二、<strong>使用System Sound Services播放音频</strong></h2><blockquote>
<p>利用<code>System Sound Services</code>只能播放一些很小的提示或警告音频，它存在诸多限制，例如：声音长度不能超过30秒，不能控制进度，格式支持少等。</p>
</blockquote>
<h3 id="1-注册音频文件"><a href="#1-注册音频文件" class="headerlink" title="1. 注册音频文件"></a>1. 注册音频文件</h3><p>调用 <code>AudioServicesCreateSystemSoundID(CFURLRef inFileURL,SystemSoundID *outSystemSoundID)</code> 该函数的第一个参数代表音频文件的URL（可通过NSURL转换成CFURLRef），第二个参数代表注册音频文件的SystemSoundID。</p>
<h3 id="2-在音频播放完执行某些操作"><a href="#2-在音频播放完执行某些操作" class="headerlink" title="2. 在音频播放完执行某些操作"></a>2. 在音频播放完执行某些操作</h3><p>调用<code>AudioServicesAddSystemSoundCompletion()</code>函数为制定SystemSoundID注册Callback函数。</p>
<h3 id="3-播放音频"><a href="#3-播放音频" class="headerlink" title="3. 播放音频"></a>3. 播放音频</h3><p>调用<code>AudioServicePlaySystemSound</code>函数或者<code>AudioServicePlayAlertSound</code>（调用系统振动功能）。</p>
<h3 id="4-实战"><a href="#4-实战" class="headerlink" title="4. 实战"></a>4. 实战</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#import <span class="title">"FKViewController.h"</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> completionCallback(SystemSoundID mySSID)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Play again after sound play completion</span></span><br><span class="line">AudioServicesPlaySystemSound(mySSID);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"><span class="comment">// 音频文件的ID</span></span><br><span class="line">SystemSoundID ditaVoice;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">[<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"><span class="comment">// 1. 定义要播放的音频文件的URL</span></span><br><span class="line"><span class="built_in">NSURL</span> *voiceURL = [[<span class="built_in">NSBundle</span> mainBundle]URLForResource:<span class="string">@"CleanDidFinish"</span> withExtension:<span class="string">@"aiff"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 注册音频文件（第一个参数是音频文件的URL 第二个参数是音频文件的SystemSoundID）</span></span><br><span class="line">AudioServicesCreateSystemSoundID((__bridge <span class="built_in">CFURLRef</span>)(voiceURL),&amp;ditaVoice);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 为crash播放完成绑定回调函数</span></span><br><span class="line">AudioServicesAddSystemSoundCompletion(ditaVoice,<span class="literal">NULL</span>,<span class="literal">NULL</span>,(<span class="keyword">void</span>*)completionCallback,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 播放 ditaVoice 注册的音频 并控制手机震动</span></span><br><span class="line">AudioServicesPlayAlertSound(ditaVoice);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    AudioServicesPlaySystemSound(ditaVoice);</span></span><br><span class="line"><span class="comment">//    AudioServicesPlaySystemSound(kSystemSoundID_Vibrate); // 控制手机振动</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用<code>System Sound Services</code>需要<code>AudioToolbox</code>框架的支持，需要导入其主头文件：<code>#import&lt;AudioToolbox/AudioToolbox.h&gt;</code></p>
</blockquote>
<hr>
<h2 id="三、使用MPMusicPlayerController控制本机音乐播放"><a href="#三、使用MPMusicPlayerController控制本机音乐播放" class="headerlink" title="三、使用MPMusicPlayerController控制本机音乐播放"></a>三、<strong>使用<code>MPMusicPlayerController</code>控制本机音乐播放</strong></h2><blockquote>
<p>对控制内置音乐库播放状态以及媒体信息的获取进行了封装，主要用于公司手环端蓝牙发送指令控制手机音乐播放以及在手环荧幕上显示歌曲名称。<br>下面介绍一下用法：</p>
<ol>
<li>包含我封装的头文件 <code>#import &quot;BackgroundMusic.h&quot;</code> </li>
<li>遵守协议：<code>achieveMusicInfoDelegate</code></li>
<li>初始化:  </li>
</ol>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic,strong) BackgroundMusic *musicController;&#10;self.musicController = [[BackgroundMusic alloc]init];&#10;self.musicController.delegate = self; // &#35774;&#32622;&#24403;&#21069;&#25511;&#21046;&#22120;&#20026;&#20195;&#29702;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>4</strong>. 监听媒体曲目的改变:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// &#22312; - (void)viewDidLoad &#26041;&#27861;&#20013;&#35843;&#29992;&#20197;&#19979;&#26041;&#38754;&#10;[self.musicController monitorMediaItem];&#10;&#10;// &#23454;&#29616;&#20195;&#29702;&#26041;&#27861;&#10;- (void)achieveachieveMusicInfo:(NSString *)songName andPlaybackStatus:(int)playStatus&#10;&#123;&#10;if (1 == playStatus) &#123;&#10;NSLog(@&#34;&#27491;&#22312;&#25773;&#25918;&#38899;&#20048;&#20013;...&#34;);&#10;&#125;else if(0 == playStatus)&#123;&#10;NSLog(@&#34;&#38899;&#20048;&#26242;&#20572;&#20013;...&#34;);&#10;&#125;else&#123;&#10;NSLog(@&#34;&#25773;&#25918;&#29366;&#24577;&#26410;&#30693;...&#34;);&#10;&#125;&#10;&#10;NSLog(@&#34;&#27468;&#26354;&#20449;&#24687;:%@&#34;,songName);&#10;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>5</strong>. 播放控制</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// &#25511;&#21046;&#38899;&#20048;&#25773;&#25918;&#12289;&#26242;&#20572;&#10;[self playOrPause];&#10;&#10;// &#19979;&#19968;&#26354;&#10;[self next];</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li>使用<code>MPMusicPlayerController</code>实例化对象来播放内置音乐库的媒体文件，有以下两种类方法来实例化对象：</li>
</ul>
<ul>
<li><code>MPMusicPlayerController *playController  = [MPMusicPlayerController systemMusicPlayer];</code><br>说明：播放内置媒体库项目取代用户目前播放状态（如果是用网易云音乐或QQQ音乐在播放歌曲）</li>
<li><code>MPMusicPlayerController *playController  = [MPMusicPlayerController applicationMusicPlayer];</code><br>说明：播放该应用内的歌曲，不影响本机自带音乐播放器的状态。</li>
</ul>
<h3 id="1-判断有没有正在播放的媒体项目"><a href="#1-判断有没有正在播放的媒体项目" class="headerlink" title="1. 判断有没有正在播放的媒体项目"></a>1. 判断有没有正在播放的媒体项目</h3><ul>
<li>返回<code>NSNotFound</code>表示<code>empty queue or an infinite playlist</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ([self.playController indexOfNowPlayingItem] == NSNotFound) &#123;&#10;return YES;&#10;&#125;else&#123;&#10;return NO;&#10;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-创建媒体队列"><a href="#2-创建媒体队列" class="headerlink" title="2. 创建媒体队列"></a>2. 创建媒体队列</h3><ul>
<li>根据<code>query</code>创建媒体队列，创建成功后可以条用<code>play</code>来播放（默认播放第 index = 0 首曲目）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/**&#10;*  &#35774;&#32622;&#23186;&#20307;&#25773;&#25918;&#38431;&#21015;&#10;*/&#10;- (void)createMediaQuery&#10;&#123;&#10;// Creates a media query that matches music items and that groups and sorts collections by song name.&#10;self.query = [MPMediaQuery songsQuery];&#10;&#10;// Sets a music player&#8217;s playback queue based on a media query.&#10;[self.playController setQueueWithQuery:self.query];&#10;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-获取正在播放的媒体曲目的信息"><a href="#3-获取正在播放的媒体曲目的信息" class="headerlink" title="3. 获取正在播放的媒体曲目的信息"></a>3. 获取正在播放的媒体曲目的信息</h3><ul>
<li>可以由<code>nowPlayingItem</code>取得一系列正在播放的曲目的详细信息：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, readonly) MPMediaEntityPersistentID &#10;@property (nonatomic, readonly) MPMediaType mediaType &#10;@property (nonatomic, readonly) NSString *title &#10;@property (nonatomic, readonly) NSString *albumTitle &#10;@property (nonatomic, readonly) MPMediaEntityPersistentID &#10;@property (nonatomic, readonly) NSString *artist &#10;@property (nonatomic, readonly) MPMediaEntityPersistentID &#10;@property (nonatomic, readonly) NSString *albumArtist &#10;...</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/**&#10;*  &#33719;&#21462;&#23186;&#20307;&#20449;&#24687;&#10;*/&#10;- (void)obtainMusicInfo&#10;&#123;&#10;MPMediaItem *currentItem = [self.playController nowPlayingItem];&#10;NSString *artist = [currentItem valueForProperty:MPMediaItemPropertyArtist];&#10;NSString *songName = [currentItem valueForProperty:MPMediaItemPropertyTitle];&#10;&#10;self.musicInfo = [NSString stringWithFormat:@&#34;%@-%@&#34;,artist,songName];&#10;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-监听播放媒体项目的通知"><a href="#4-监听播放媒体项目的通知" class="headerlink" title="4. 监听播放媒体项目的通知"></a>4. 监听播放媒体项目的通知</h3><ul>
<li>监听此通知可以在播放曲目发生改变时（如：下一曲、上一曲）作出动作。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSNotificationCenter *notificationCenter = [NSNotificationCenter defaultCenter];&#10;[notificationCenter addObserver:self&#10;selector:@selector(updateMusicInfo)&#10;name:MPMusicPlayerControllerNowPlayingItemDidChangeNotification&#10;object:nil];&#10;&#10;[self.playController beginGeneratingPlaybackNotifications];</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/systemMusicPlayer-audioPlayer/">systemMusicPlayer, audioPlayer</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-基于百度地图SDK记录运动轨迹" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/22/基于百度地图SDK记录运动轨迹/" class="article-date">
  	<time datetime="2016-02-22T01:17:07.000Z" itemprop="datePublished">2016-02-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/22/基于百度地图SDK记录运动轨迹/">基于百度地图SDK记录运动轨迹</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、-前期准备工作"><a href="#一、-前期准备工作" class="headerlink" title="一、 前期准备工作"></a>一、 前期准备工作</h2><p>首先需要登录<a href="http://developer.baidu.com/map/index.php?title=首页" target="_blank" rel="external">百度开放平台</a>下载<strong>iOS地图SDK</strong>（内含开发者文档、框架以及Demo示例），推荐下载全新Framework形式的静态库，配置更加简单方便，具体看下图：<br><img src="http://ww4.sinaimg.cn/large/9c83136agw1eu4gfymeosj20xm0dy77h.jpg" alt="百度开放平台"></p>
<p><img src="http://img-storage.qiniudn.com/15-7-16/88952331.jpg" alt="framework静态库"></p>
<hr>
<h3 id="1-新建Xcode工程"><a href="#1-新建Xcode工程" class="headerlink" title="1. 新建Xcode工程"></a>1. 新建Xcode工程</h3><p><em>File-&gt;New-&gt;Project-&gt;Single View Application</em>，填写好相关信息完成工程建立。<br><img src="http://7xkf7q.com1.z0.glb.clouddn.com/15-7-16/5796134.jpg" alt="新建工程"></p>
<hr>
<h3 id="2-获取Bundle-Identifier"><a href="#2-获取Bundle-Identifier" class="headerlink" title="2. 获取Bundle Identifier"></a>2. 获取Bundle Identifier</h3><p>通过<em>project-&gt;target-&gt;general</em>可以看到本应用的<em>Bundle Identifie</em>，我们正是需要这串字符串去百度开发平台申请一个Key用于百度地图的调用。<br><img src="http://7xkf7q.com1.z0.glb.clouddn.com/15-7-16/13755680.jpg" alt="Bundle Identifie"></p>
<hr>
<h3 id="3-申请key"><a href="#3-申请key" class="headerlink" title="3. 申请key"></a>3. 申请key</h3><p>登录<a href="http://developer.baidu.com/map/index.php?title=首页" target="_blank" rel="external">百度开放平台</a>后，点击右上角的<em>API控制台</em>进入申请key的界面，点击<em>创建应用</em>，在“安全码”处填入你的应用的<em>Bundle Identifie</em>，具体信息填写请看下图：<br><img src="http://7xkf7q.com1.z0.glb.clouddn.com/15-7-16/52741447.jpg" alt="申请key信息填写图1"><br><img src="http://7xkf7q.com1.z0.glb.clouddn.com/15-7-16/86559904.jpg" alt="申请key信息填写图2"></p>
<hr>
<h3 id="4-导入框架配置工程"><a href="#4-导入框架配置工程" class="headerlink" title="4. 导入框架配置工程"></a>4. 导入框架配置工程</h3><blockquote>
<p><strong>第一步</strong> 、引入<code>BaiduMapAPI.framework</code><br>百度地图SDK提供了模拟器和真机两种环境所使用的framework，分别存放在<em>libs/Release-iphonesimulator和libs/Release-iphoneos</em>文件夹下，开发者可根据需要使用真机或模拟器的包，如果需同时使用真机和模拟器的包，可以使用<em>lipo</em>命令将设备和模拟器framwork包中的BaiduMapAPI文件合并成一个通用的文件，命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lipo -create Release-iphoneos/BaiduMapAPI.framework/BaiduMapAPI Release-iphonesimulator/BaiduMapAPI.framework/BaiduMapAPI -output Release-iphoneos/BaiduMapAPI.framework/BaiduMapAPI</span><br></pre></td></tr></table></figure></p>
<p>此时<code>Release-iphoneos</code>文件夹下的<code>BaiduMapAPI.framework</code>即可同时用于真机和模拟器。将所需的<code>BaiduMapAPI.framework</code>拷贝到工程所在文件夹下。在<code>TARGETS-&gt;Build Phases-&gt; Link Binary With Libaries</code>中点击<code>+</code>按钮，在弹出的窗口中点击“Add Other”按钮，选择<code>BaiduMapAPI.framework</code>文件添加到工程中。<br>注:静态库中采用<code>ObjectC++</code>实现，因此需要您保证您工程中至少有一个.mm后缀的源文件(您可以将任意一个.m后缀的文件改名为.mm)，或者在工程属性中指定编译方式，即将<em>Xcode的Project -&gt; Edit Active Target -&gt; Build -&gt; GCC4.2 - Language -&gt; Compile Sources As</em>设置为<code>Objective-C++</code>。</p>
<p><strong>第二步</strong>、引入所需的系统库<br>百度地图SDK中提供了定位功能和动画效果，v2.0.0版本开始使用OpenGL渲染，因此您需要在您的Xcode工程中引入<code>CoreLocation.framework</code>和<code>QuartzCore.framework</code>、<code>OpenGLES.framework</code>、<br><code>SystemConfiguration.framework</code>、<code>CoreGraphics.framework</code>、<br><code>Security.framework</code>。添加方式：在<em>Xcode的Project -&gt; Active Target -&gt;Build Phases -&gt;Link Binary With Libraries</em>，添加这几个framework即可。</p>
<p><strong>第三步</strong>、环境配置<br>在<code>TARGETS-&gt;Build Settings-&gt;Other Linker Flags</code>中添加<code>-ObjC</code>。</p>
<p><strong>第四步</strong>、引入<em>mapapi.bundle资源文件</em><br>如果使用了基础地图功能，需要添加该资源，否则地图不能正常显示<br><code>mapapi.bundle</code>中存储了定位、默认大头针标注<code>View</code>及路线关键点的资源图片，还存储了矢量地图绘制必需的资源文件。如果您不需要使用内置的图片显示功能，则可以删除<code>bundle</code>文件中的<code>image</code>文件夹。您也可以根据具体需求任意替换或删除该bundle中image文件夹的图片文件。<br>方法：选中工程名，在右键菜单中选择<code>Add Files to “工程名”…</code>，从<code>BaiduMapAPI.framework||Resources</code>文件中选择<code>mapapi.bundle</code>文件，并勾选<code>“Copy items if needed”</code>复选框，单击<code>Add</code>按钮，将资源文件添加到工程中。</p>
<p><strong>第五步</strong>、引入头文件<br>在使用SDK的类引入头文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#import &#60;BaiduMapAPI/BMapKit.h&#62;//&#24341;&#20837;&#25152;&#26377;&#30340;&#22836;&#25991;&#20214;&#10;#import &#60;BaiduMapAPI/BMKMapView.h&#62;//&#21482;&#24341;&#20837;&#25152;&#38656;&#30340;&#21333;&#20010;&#22836;&#25991;&#20214;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>–<a href="http://developer.baidu.com/map/index.php?title=iossdk/guide/buildproject" target="_blank" rel="external">引用自百度开放平台iOS SDK环境配置</a></p>
<hr>
<h3 id="5-初始化-BMKMapManager"><a href="#5-初始化-BMKMapManager" class="headerlink" title="5. 初始化 BMKMapManager"></a>5. 初始化 <em>BMKMapManager</em></h3><ul>
<li><p>在<code>AppDelegate.m</code> 中添加 <code>BMKMapManager</code>的定义：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@interface AppDelegate ()&#60;BMKGeneralDelegate&#62;&#10;&#10;@property (nonatomic,strong) BMKMapManager *mapManager;&#10;&#10;@end</span><br></pre></td></tr></table></figure>
</li>
<li><p>遵守 <code>BMKGeneralDelegate</code> 实现其两个代理方法，目的是为了得知本应用是否联网成功、授权成功：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)onGetNetworkState:(int)iError&#10;&#123;&#10;if (0 == iError) &#123;&#10;NSLog(@&#34;&#32852;&#32593;&#25104;&#21151;&#34;);&#10;&#125;&#10;else&#123;&#10;NSLog(@&#34;onGetNetworkState %d&#34;,iError);&#10;&#125;&#10;&#10;&#125;&#10;&#10;- (void)onGetPermissionState:(int)iError&#10;&#123;&#10;if (0 == iError) &#123;&#10;NSLog(@&#34;&#25480;&#26435;&#25104;&#21151;&#34;);&#10;&#125;&#10;else &#123;&#10;NSLog(@&#34;onGetPermissionState %d&#34;,iError);&#10;&#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://7xkf7q.com1.z0.glb.clouddn.com/15-7-16/34524205.jpg" alt="BMKGeneralDelegate.h"></p>
<ul>
<li>在AppDelegate.m文件中添加对BMKMapManager的初始化，并填入申请的授权Key，示例如下:<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions &#123;&#10;&#10;// &#35201;&#20351;&#29992;&#30334;&#24230;&#22320;&#22270;&#20808;&#23454;&#20363;&#21270; BMKMapManager&#10;self.mapManager = [[BMKMapManager alloc]init];&#10;&#10;// &#22914;&#26524;&#35201;&#20851;&#27880;&#32593;&#32476;&#21450;&#25480;&#26435;&#39564;&#35777;&#20107;&#20214;&#65292;&#35831;&#35774;&#23450; generalDelegate &#21442;&#25968;&#10;BOOL ret = [self.mapManager start:@&#34;OjYbYha0YULmuLPaHT9wxxx&#34; generalDelegate:self];&#10;if (!ret) &#123;&#10;NSLog(@&#34;manager start failed&#34;);&#10;&#125;&#10;return YES;&#10;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="二、实战记录运动轨迹"><a href="#二、实战记录运动轨迹" class="headerlink" title="二、实战记录运动轨迹"></a>二、实战记录运动轨迹</h2><p><strong>一条完整的运动轨迹是由一组地理位置坐标数组描点连线构成的，我们需要实时监测用户位置的变更，将最新的符合限定条件的地位位置数据存放到数据中，调用SDK中的画折线方法绘制运动轨迹。</strong></p>
<hr>
<h3 id="1-初始化工作"><a href="#1-初始化工作" class="headerlink" title="1. 初始化工作"></a>1. 初始化工作</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> () &lt;<span class="title">BMKMapViewDelegate</span>, <span class="title">BMKLocationServiceDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** 记录上一次的位置 */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) CLLocation *preLocation;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 位置数组 */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span> *locationArrayM;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 轨迹线 */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) B<span class="built_in">MKPolyline</span> *polyLine;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 百度地图View */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) B<span class="built_in">MKMapView</span> *mapView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 百度定位地图服务 */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) B<span class="built_in">MKLocationService</span> *bmkLocationService;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">[<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化百度位置服务</span></span><br><span class="line">[<span class="keyword">self</span> initBMLocationService];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化地图窗口</span></span><br><span class="line"><span class="keyword">self</span><span class="variable">.mapView</span> = [[B<span class="built_in">MKMapView</span> alloc]initWithFrame:<span class="keyword">self</span><span class="variable">.view</span><span class="variable">.bounds</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置MapView的一些属性</span></span><br><span class="line">[<span class="keyword">self</span> setMapViewProperty];</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span><span class="variable">.view</span> addSubview:<span class="keyword">self</span><span class="variable">.mapView</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>初始化MapView后设置其一些属性</strong>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">*  设置 百度MapView的一些属性</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)setMapViewProperty</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 显示定位图层</span></span><br><span class="line"><span class="keyword">self</span><span class="variable">.mapView</span><span class="variable">.showsUserLocation</span> = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置定位模式</span></span><br><span class="line"><span class="keyword">self</span><span class="variable">.mapView</span><span class="variable">.userTrackingMode</span> = B<span class="built_in">MKUserTrackingModeNone</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 允许旋转地图</span></span><br><span class="line"><span class="keyword">self</span><span class="variable">.mapView</span><span class="variable">.rotateEnabled</span> = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示比例尺</span></span><br><span class="line"><span class="keyword">self</span><span class="variable">.bmkMapView</span><span class="variable">.showMapScaleBar</span> = <span class="literal">YES</span>;</span><br><span class="line"><span class="keyword">self</span><span class="variable">.bmkMapView</span><span class="variable">.mapScaleBarPosition</span> = <span class="built_in">CGPointMake</span>(<span class="keyword">self</span><span class="variable">.view</span><span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.width</span> - <span class="number">50</span>, <span class="keyword">self</span><span class="variable">.view</span><span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.height</span> - <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定位图层自定义样式参数</span></span><br><span class="line">B<span class="built_in">MKLocationViewDisplayParam</span> *displayParam = [[B<span class="built_in">MKLocationViewDisplayParam</span> alloc]init];</span><br><span class="line">displayParam<span class="variable">.isRotateAngleValid</span> = <span class="literal">NO</span>;<span class="comment">//跟随态旋转角度是否生效</span></span><br><span class="line">displayParam<span class="variable">.isAccuracyCircleShow</span> = <span class="literal">NO</span>;<span class="comment">//精度圈是否显示</span></span><br><span class="line">displayParam<span class="variable">.locationViewOffsetX</span> = <span class="number">0</span>;<span class="comment">//定位偏移量(经度)</span></span><br><span class="line">displayParam<span class="variable">.locationViewOffsetY</span> = <span class="number">0</span>;<span class="comment">//定位偏移量（纬度）</span></span><br><span class="line">displayParam<span class="variable">.locationViewImgName</span> = <span class="string">@"walk"</span>;</span><br><span class="line">[<span class="keyword">self</span><span class="variable">.mapView</span> updateLocationViewWithParam:displayParam];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>百度定位服务的参数设置</strong>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">*  初始化百度位置服务</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)initBMLocationService</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 初始化位置百度位置服务</span></span><br><span class="line"><span class="keyword">self</span><span class="variable">.bmkLocationService</span> = [[B<span class="built_in">MKLocationService</span> alloc] init];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置距离过滤，表示每移动10更新一次位置</span></span><br><span class="line">[B<span class="built_in">MKLocationService</span> setLocationDistanceFilter:<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置定位精度</span></span><br><span class="line">[B<span class="built_in">MKLocationService</span> setLocationDesiredAccuracy:kCLLocationAccuracyBest];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="2-开始定位"><a href="#2-开始定位" class="headerlink" title="2. 开始定位"></a>2. 开始定位</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打开定位服务</span></span><br><span class="line">[<span class="keyword">self</span><span class="variable">.bmkLocationService</span> startUserLocationService];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置当前地图的显示范围，直接显示到用户位置</span></span><br><span class="line">B<span class="built_in">MKCoordinateRegion</span> adjustRegion = [<span class="keyword">self</span><span class="variable">.mapView</span> regionThatFits:B<span class="built_in">MKCoordinateRegionMake</span>(<span class="keyword">self</span><span class="variable">.bmkLocationService</span><span class="variable">.userLocation</span><span class="variable">.location</span><span class="variable">.coordinate</span>, B<span class="built_in">MKCoordinateSpanMake</span>(<span class="number">0.02</span>f,<span class="number">0.02</span>f))];</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span><span class="variable">.mapView</span> setRegion:adjustRegion animated:<span class="literal">YES</span>];</span><br></pre></td></tr></table></figure>
<p>只要遵守了<code>BMKLocationServiceDelegate</code>协议就可以获知位置更新的情况，需要实现下面几个代理方法：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">*  定位失败会调用该方法</span><br><span class="line">*</span><br><span class="line">*  @param error 错误信息</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)didFailToLocateUserWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"did failed locate,error is %@"</span>,[error localizedDescription]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">*  用户位置更新后，会调用此函数</span><br><span class="line">*  @param userLocation 新的用户位置</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)didUpdateB<span class="built_in">MKUserLocation</span>:(B<span class="built_in">MKUserLocation</span> *)userLocation</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 如果此时位置更新的水平精准度大于10米，直接返回该方法</span></span><br><span class="line"><span class="comment">// 可以用来简单判断GPS的信号强度</span></span><br><span class="line"><span class="keyword">if</span> (userLocation<span class="variable">.location</span><span class="variable">.horizontalAccuracy</span> &gt; kCLLocationAccuracyNearestTenMeters) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">*  用户方向更新后，会调用此函数</span><br><span class="line">*  @param userLocation 新的用户位置</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)didUpdateUserHeading:(B<span class="built_in">MKUserLocation</span> *)userLocation</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 动态更新我的位置数据</span></span><br><span class="line">[<span class="keyword">self</span><span class="variable">.mapView</span> updateLocationData:userLocation];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="3-存储更新的用户地理位置"><a href="#3-存储更新的用户地理位置" class="headerlink" title="3.  存储更新的用户地理位置"></a>3.  存储更新的用户地理位置</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">*  开始记录轨迹</span><br><span class="line">*</span><br><span class="line">*  @param userLocation 实时更新的位置信息</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)recordTrackingWithUserLocation:(B<span class="built_in">MKUserLocation</span> *)userLocation</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.preLocation</span>) &#123;</span><br><span class="line"><span class="comment">// 计算本次定位数据与上次定位数据之间的距离</span></span><br><span class="line"><span class="built_in">CGFloat</span> distance = [userLocation<span class="variable">.location</span> distanceFromLocation:<span class="keyword">self</span><span class="variable">.preLocation</span>];</span><br><span class="line"><span class="keyword">self</span><span class="variable">.statusView</span><span class="variable">.distanceWithPreLoc</span><span class="variable">.text</span> = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%.3f"</span>,distance];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"与上一位置点的距离为:%f"</span>,distance);</span><br><span class="line"></span><br><span class="line"><span class="comment">// (5米门限值，存储数组画线) 如果距离少于 5 米，则忽略本次数据直接返回方法</span></span><br><span class="line"><span class="keyword">if</span> (distance &lt; <span class="number">5</span>) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 将符合的位置点存储到数组中（第一直接来到这里）</span></span><br><span class="line">[<span class="keyword">self</span><span class="variable">.locationArrayM</span> addObject:userLocation<span class="variable">.location</span>];</span><br><span class="line"><span class="keyword">self</span><span class="variable">.preLocation</span> = userLocation<span class="variable">.location</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 绘图</span></span><br><span class="line">[<span class="keyword">self</span> drawWalkPolyline];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="4-绘制轨迹线"><a href="#4-绘制轨迹线" class="headerlink" title="4. 绘制轨迹线"></a>4. 绘制轨迹线</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">*  绘制轨迹路线</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)drawWalkPolyline</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 轨迹点数组个数</span></span><br><span class="line"><span class="built_in">NSUInteger</span> count = <span class="keyword">self</span><span class="variable">.locationArrayM</span><span class="variable">.count</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态分配存储空间</span></span><br><span class="line"><span class="comment">// BMKMapPoint是个结构体：地理坐标点，用直角地理坐标表示 X：横坐标 Y：纵坐标</span></span><br><span class="line">B<span class="built_in">MKMapPoint</span> *tempPoints = new B<span class="built_in">MKMapPoint</span>[count];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历数组</span></span><br><span class="line">[<span class="keyword">self</span><span class="variable">.locationArrayM</span> enumerateObjectsUsingBlock:^(CLLocation *location, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">B<span class="built_in">MKMapPoint</span> locationPoint = B<span class="built_in">MKMapPointForCoordinate</span>(location<span class="variable">.coordinate</span>);</span><br><span class="line">tempPoints[idx] = locationPoint;</span><br><span class="line">&#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//移除原有的绘图，避免在原来轨迹上重画</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.polyLine</span>) &#123;</span><br><span class="line">[<span class="keyword">self</span><span class="variable">.mapView</span> removeOverlay:<span class="keyword">self</span><span class="variable">.polyLine</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过points构建BMKPolyline</span></span><br><span class="line"><span class="keyword">self</span><span class="variable">.polyLine</span> = [B<span class="built_in">MKPolyline</span> polylineWithPoints:tempPoints count:count];</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加路线,绘图</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.polyLine</span>) &#123;</span><br><span class="line">[<span class="keyword">self</span><span class="variable">.mapView</span> addOverlay:<span class="keyword">self</span><span class="variable">.polyLine</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空 tempPoints 临时数组</span></span><br><span class="line">delete []tempPoints;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据polyline设置地图范围</span></span><br><span class="line">[<span class="keyword">self</span> mapViewFitPolyLine:<span class="keyword">self</span><span class="variable">.polyLine</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/mapTrack-BaiduMap/">mapTrack, BaiduMap</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-NSPredicate" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/21/NSPredicate/" class="article-date">
  	<time datetime="2016-02-21T08:14:21.000Z" itemprop="datePublished">2016-02-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/21/NSPredicate/">NSPredicate</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>NSPredicate 是一个Foundation的类，用来定义逻辑条件约束的获取或内存中的过滤搜索，相当于SQL中的<code>where</code>用法。</p>
</blockquote>
<h2 id="1-集合中使用-NSPredicate"><a href="#1-集合中使用-NSPredicate" class="headerlink" title="1.集合中使用 NSPredicate"></a>1.集合中使用 NSPredicate</h2><ul>
<li>Foundation提供了<code>Predicate</code>来过滤<code>NSArray</code>、<code>NSMutableArray</code>、<code>NSSet</code>、<code>NSMutableSet</code>、<code>NSDictionary</code>等集合的方法。</li>
<li><code>NSArray&amp;NSSet</code>（不可变集合）：通过<code>filteredArrayUsingPredicate</code>、<code>filteredSetUsingPredicate:</code>方法评估一个接收到的<code>predicate</code>来返回一个不可变集合。</li>
<li><code>NSMutableArray&amp;NSMutableSet</code>（可变集合）：通过<code>filterUsingPredicate:</code>方法评估一个接收到的<code>predicate</code>来移除评估结果为FALSE的对象，这个可变数组将仅剩下符合要求的对象。同样地，也可以使用<code>filteredArrayUsingPredicate</code>、<code>filteredSetUsingPredicate:</code>方法来过滤返回一个符合要求的不可变集合。</li>
<li><code>NSDictionary</code>：可以使用<code>predicate</code>来过滤分别过滤键值。</li>
</ul>
<h3 id="CodeSnippest"><a href="#CodeSnippest" class="headerlink" title="CodeSnippest:"></a>CodeSnippest:</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableArray</span> *mutArr = [<span class="built_in">NSMutableArray</span> arrayWithObjects:<span class="string">@"bang"</span>,<span class="string">@"bing"</span>,<span class="string">@"jklb"</span>,<span class="string">@"dgjk"</span>,<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"before filter mutArr is %@"</span>,mutArr); </span><br><span class="line"><span class="built_in">NSPredicate</span> *predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"SELF CONTAINS[cd] %@"</span>,<span class="string">@"g"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可变数组不会被改变，返回一个不可变数组</span></span><br><span class="line"><span class="built_in">NSArray</span> *arr = [mutArr filteredArrayUsingPredicate:predicate]; </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"after filter mutArr is %@,arr is %@"</span>,mutArr,arr); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 可变数组被变更，只剩下符合条件的对象</span></span><br><span class="line">[mutArr filterUsingPredicate:predicate]; </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"after filter mutArr is %@"</span>,mutArr);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="2-谓词语法"><a href="#2-谓词语法" class="headerlink" title="2.谓词语法"></a>2.谓词语法</h2><ul>
<li><strong>替换</strong></li>
</ul>
<blockquote>
<p><code>%@</code> 是对值为字符串，数字或者日期的对象的替换值，<code>%K</code> 是key path的替换值</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一种写法</span></span><br><span class="line"><span class="built_in">NSPredicate</span> *bobPredicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"firstName = 'Bob'"</span>];</span><br><span class="line"><span class="built_in">NSPredicate</span> *ageIs33Predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"%K = %@"</span>, <span class="string">@"age"</span>, @<span class="number">33</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种写法</span></span><br><span class="line"><span class="built_in">NSPredicate</span> *bobPredicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"@"</span>%K = %<span class="string">@",@"</span>firstName<span class="string">",@"</span>Bob<span class="string">""</span>];</span><br><span class="line"><span class="built_in">NSPredicate</span> *ageIs33Predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"age = 33"</span>];</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>$VARIABLE_NAME</code>是可以被NSPredicate <code>-predicateWithSubstitutionVariables:</code>替换的值。</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableArray</span> *mutArr = [<span class="built_in">NSMutableArray</span> arrayWithObjects:<span class="string">@"bang"</span>,<span class="string">@"bing"</span>,<span class="string">@"jklb"</span>,<span class="string">@"dgjk"</span>,<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSPredicate</span> *predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"SELF CONTAINS[cd] $letter"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[mutArr filteredArrayUsingPredicate:[predicate predicateWithSubstitutionVariables:@&#123;<span class="string">@"letter"</span>:<span class="string">@"l"</span>&#125;]]);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>基本比较</strong> ：=(==)、&lt;、&gt;、&lt;=(=&lt;)、&gt;=(=&gt;)、!=(&lt;&gt;)、BETWEEN</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *arr = @[@<span class="number">2</span>,@<span class="number">3</span>,@<span class="number">4</span>,@<span class="number">5</span>];</span><br><span class="line"><span class="built_in">NSPredicate</span> *arrPredicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"SELF BETWEEN &#123;4,10&#125;"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[arr filteredArrayUsingPredicate:arrPredicate]);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>复合谓词</strong> ：AND(&amp;&amp;)、OR(||)、NOT(!)</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *arr = @[<span class="string">@"kezhen"</span>,<span class="string">@"bole"</span>,<span class="string">@"Archae"</span>,<span class="string">@"arphan"</span>];</span><br><span class="line"><span class="built_in">NSPredicate</span> *arrPredicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"(SELF BEGINSWITH %@) AND (SELF ENDSWITH %@)"</span>,<span class="string">@"b"</span>,<span class="string">@"e"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[arr filteredArrayUsingPredicate:arrPredicate]);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>字符串比较相关</strong>：<code>BEGINSWITH</code>：以指定字符串开始；<code>CONTAINS</code>：包含指定字符串；<code>ENDSWITH</code>：以指定字符串结束；<code>LIKE</code>：左边表达式等于右边表达式，<code>?</code>匹配一个字符，<code>*</code>匹配0个或多个字符；MATCHES：左边的表达式根据ICU v3（更多内容请查看ICU User Guide for Regular Expressions）的regex风格比较，等于右边的表达式。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LIKE</span></span><br><span class="line"><span class="built_in">NSArray</span> *arr = @[<span class="string">@"kezhen"</span>,<span class="string">@"bole"</span>,<span class="string">@"orchan"</span>,<span class="string">@"orphan"</span>];</span><br><span class="line"><span class="built_in">NSPredicate</span> *arrPredicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"SELF LIKE %@"</span>,<span class="string">@"?rc*"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[arr filteredArrayUsingPredicate:arrPredicate]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// BETWEEN</span></span><br><span class="line"><span class="built_in">NSArray</span> *arr = @[<span class="string">@"kezhen"</span>,<span class="string">@"bole"</span>,<span class="string">@"Archae"</span>,<span class="string">@"arphan"</span>];</span><br><span class="line"><span class="built_in">NSString</span> *regex = <span class="string">@"^A.+e$"</span>; <span class="comment">//以A开头，e结尾</span></span><br><span class="line"><span class="built_in">NSPredicate</span> *arrPredicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"SELF MATCHES %@"</span>,regex];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[arr filteredArrayUsingPredicate:arrPredicate]);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>关系操作</strong>：ANY、ALL、NONE、IN</li>
</ul>
<hr>
<h2 id="3-创建复合谓词"><a href="#3-创建复合谓词" class="headerlink" title="3.创建复合谓词"></a>3.创建复合谓词</h2><blockquote>
<p>除了用复合谓词关键字连接组合多个谓词，还可以可用以下方法。</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSCompoundPredicate</span> andPredicateWithSubpredicates:@[[<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"age &gt; 25"</span>], [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"firstName = %@"</span>, <span class="string">@"Quentin"</span>]]];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用关键字连接组合多个谓词</span></span><br><span class="line">[<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"(age &gt; 25) AND (firstName = %@)"</span>, <span class="string">@"Quentin"</span>];</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="4-Block谓词"><a href="#4-Block谓词" class="headerlink" title="4.Block谓词"></a>4.Block谓词</h2><blockquote>
<p>block可以封装任意的计算，所以有一个查询类是无法以NSPredicate格式字符串形式来表达的（比如对运行时被动态计算的值的评估）。</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSPredicate</span> *pre = [<span class="built_in">NSPredicate</span> predicateWithBlock:^<span class="built_in">BOOL</span>(<span class="keyword">id</span>  _Nonnull evaluatedObject, <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; * _Nullable bindings) &#123;</span><br><span class="line"><span class="keyword">return</span> [[evaluatedObject firstName] length] &lt; <span class="number">3</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"firstName.length %@"</span>,[arr filteredArrayUsingPredicate:pre]);</span><br></pre></td></tr></table></figure>
<ul>
<li>参考来源：<br><a href="http://nshipster.cn/nspredicate/" target="_blank" rel="external">NSPredicate - Mattt Thompson撰写、 Zihan Xu翻译、 发布于2013年7月15日</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/filter-NSPredicate/">filter NSPredicate</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-AVAudioSession-Programming-Guide" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/21/AVAudioSession-Programming-Guide/" class="article-date">
  	<time datetime="2016-02-21T06:43:09.000Z" itemprop="datePublished">2016-02-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/21/AVAudioSession-Programming-Guide/">AVAudioSession Programming Guide</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Defining-an-Audio-Session"><a href="#Defining-an-Audio-Session" class="headerlink" title="Defining an Audio Session"></a>Defining an Audio Session</h2><p>在你的应用中使用声音播放需要定义一个合适的<code>audio session</code>，它会配置你的应用的声音行为。例如</p>
<ul>
<li>是否让其他应用（音乐播放器）和你的应用声音进行混合</li>
<li>来电或闹钟打断应用的声音播放应该如何恢复中断</li>
<li>插拔耳机你的应用应该作何回应</li>
</ul>
<p>当你的应用启动时，<code>audio session</code>的配置影响到所有音频的活动除了使用<code>System Sounds Services</code> API 播放的音频。你可以通过<code>audio session</code>查询到你应用所在的设备的硬件特性，例如：声道数量和采样率等。你可以激活和反激活你的<code>audio session</code>，系统也能够主动反激活你的<code>audio session</code>，例如来电和闹钟。</p>
<h3 id="1-1-Audio-Session-Default-Behavior"><a href="#1-1-Audio-Session-Default-Behavior" class="headerlink" title="1.1 Audio Session Default Behavior"></a>1.1 Audio Session Default Behavior</h3><p><code>audio session</code>有一些默认的行为：</p>
<ul>
<li>正在播放音视频时不可以进行录制</li>
<li>应用声音播放跟随静音键的设置（静音键打开应用静音）</li>
<li>应用声音跟随锁屏（锁频应用静音）</li>
<li>应用声音独占播放（不允许其他应用与之混音）</li>
</ul>
<p>以上的这些音频默认行为来自系统默认选择的<code>AVAudioSessionCategorySoloAmbient</code>。<br>在开发过程中，你可以采用上面这些默认的音频行为。不过，在以下几种情况你可以放心地忽略<code>audio session</code>的设置：</p>
<ul>
<li>你的应用播放声音使用<code>System Sound Services or the UIKit playInputClick method</code>，且没有使用音其他音频API。<blockquote>
<p><code>System Sound Services</code>用于播放用户交互界面上的简短声音提示以及调用设备的震动功能。<code>The UIKit playInputClick</code> 方法让你在自定义的输入或键盘附件中播放标准的敲击声，它的音频行为由系统处理。</p>
</blockquote>
</li>
<li>你的应用根本没有使用到音频</li>
</ul>
<p>在有其他音频行为需求下，不要使用默认的<code>audio session</code>。</p>
<h3 id="1-2-Why-a-Default-Audio-Session-Usually-Isn’t-What-You-Want"><a href="#1-2-Why-a-Default-Audio-Session-Usually-Isn’t-What-You-Want" class="headerlink" title="1.2 Why a Default Audio Session Usually Isn’t What You Want"></a>1.2 Why a Default Audio Session Usually Isn’t What You Want</h3><p>如果你没有实例化、配置以及清晰地使用你的<code>audio session</code>，你的应用则不能对音频线路改变或中断作出响应。<br>下面是一些演示默认音频行为的场景以及如何去改变它：</p>
<ul>
<li>场景1。你写了一个电子书应用。一个用户开始听《西游记》，不久设备自动锁屏了，应用也静音了。<blockquote>
<p>为了保证设备锁屏后依然能够正常播放声音，应该配置一个<code>audio session</code>支持播放并且在<code>UIBackgroundModes</code>中设置打开音频后台使用开关。</p>
</blockquote>
</li>
<li>场景2。你写了一个第一人称的射击游戏，使用了<code>OpenAL-based sound effects</code>。你提供了一个背景声音播放轨道，可以给用户播放音乐库的歌曲。当歌曲正在播放到一半时，你开炮射击了敌人的集中营，随之歌曲停止播放了。<blockquote>
<p>为了确保你的歌曲不会被打断，应该设置<code>audio session</code>允许被混音。使用<code>AVAudioSessionCategoryAmbient</code>或者修改<code>AVAudioSessionCategoryPlayback</code>来支持混音。（详情见<code>Fine-Tuning category</code>）。</p>
</blockquote>
</li>
<li>场景3。你写了一个流媒体音频应用，使用<code>Audio Queue Services</code>来播放。当一个用户在收听时，一个电话打进来了，正如我们所预料到的应用停止播放了。用户选择挂断电话，返回应用点击播放但不再响应。为了恢复播放，用户需要重启应用。<blockquote>
<p>为了能够优雅地处理音频队列的中断，设置合适的<code>category</code>并且监听<code>AVAudioSessionInterruptionNotification</code>。</p>
</blockquote>
</li>
</ul>
<h3 id="1-3-Initializing-Your-Audio-Session"><a href="#1-3-Initializing-Your-Audio-Session" class="headerlink" title="1.3 Initializing Your Audio Session"></a>1.3 Initializing Your Audio Session</h3><p>在你的应用启动时系统就提供了一个<code>audio session</code>对象。然而，为了处理中断事件你必须实例化这个<code>audio session</code>。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// implicitly initializes your audio session</span></span><br><span class="line"><span class="built_in">AVAudioSession</span> *session = [<span class="built_in">AVAudioSession</span> sharedInstance];</span><br></pre></td></tr></table></figure>
<p>这个<code>session</code>代表被初始化的<code>audio session</code>，可以马上使用。当你使用<code>AVAudioSession class’s interruption notifications</code>或<code>delegate protocols of the AVAudioPlayer and AVAudioRecorder classes</code>处理中断时，苹果官方推荐对<code>audio session</code>进行隐式地初始化。</p>
<h3 id="1-4-Adding-Volume-and-Route-Control"><a href="#1-4-Adding-Volume-and-Route-Control" class="headerlink" title="1.4 Adding Volume and Route Control"></a>1.4 Adding Volume and Route Control</h3><p>使用<code>MPVolumeView</code>类去为你的APP展示音量和线路控制。这个<code>volume view</code>提供了一个滑动条在应用内部控制音量，还提供了一个旋钮选择音频输出线路。当输出音频到内置扬声器时，苹果官方推荐通过<code>AVAudioSessionPortOverride</code>使用<code>MPVolumeView route picker</code>。</p>
<h3 id="1-5-Responding-to-Remote-Control-Events"><a href="#1-5-Responding-to-Remote-Control-Events" class="headerlink" title="1.5 Responding to Remote Control Events"></a>1.5 Responding to Remote Control Events</h3><p>远程控制事件让用户控制应用的多媒体播放。如果你的应用播放音频或视频内容，你可能想要响应来自传输控件或外部附件的远程控制事件。iOS转换<code>UIEvent</code>对象的命令，传递事件到APP。APP把事件发送给第一响应者，如果第一响应者没有处理它们，将沿着响应链传递下去。你的APP一定要是“Now Playing”，否则不能响应事件。</p>
<h3 id="1-6-Activating-and-Deactivating-Your-Audio-Session"><a href="#1-6-Activating-and-Deactivating-Your-Audio-Session" class="headerlink" title="1.6 Activating and Deactivating Your Audio Session"></a>1.6 Activating and Deactivating Your Audio Session</h3><p>在你的APP启动时，系统将激活你的<code>audio session</code>。即使这样，苹果官方推荐在<code>viewDidLoad</code>方法中显式激活它，同时优先设置硬件偏好值。具体参照<code>Setting Preferred Hardware Values</code>代码，这可以测试是否激活成功。<br>下面展示如何激活APP的<code>audio session</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> *activationError = <span class="literal">nil</span>;</span><br><span class="line"><span class="built_in">BOOL</span> success = [[<span class="built_in">AVAudioSession</span> sharedInstance] setActive: <span class="literal">YES</span> error: &amp;activationError];</span><br><span class="line"><span class="keyword">if</span> (!success) &#123; <span class="comment">/* handle the error in activationError */</span> &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>反激活则传递 <code>NO</code> 到 <code>setActive</code> 参数中。</p>
</blockquote>
<p>在使用<code>AVAudioPlayer</code>对象播放声音或使用<code>AVAudioRecorder</code>对象录制音频的具体使用例子中，系统很关心在中断结束后<code>audio session</code>的重新激活。苹果官方推荐监听通知消息来重新激活<code>audio session</code>。如此，你可以确保重新激活成功，与此同时你可以更新应用的状态和UI。<br>大多数应用不需要显示地反激活<code>audio session</code>，如：VOIP、语音导航、录音的应用。</p>
<ul>
<li>要确保经常在后台运行的VOIP应用的<code>audio session</code>只有在处理通话时才是处于激活状态的。在后台等待处理电话通知时的<code>audio session</code>不应该被激活。</li>
<li>设置为<code>recording category</code>应用的<code>audio session</code>只有在录制情况下才处于激活状态。在录制开始前和录制结束时，要确保你的应用的<code>audio session</code>是处于非激活状态来允许其他声音播放。</li>
</ul>
<h3 id="1-7-Checking-Whether-Other-Audio-Is-Playing-During-App-Launch"><a href="#1-7-Checking-Whether-Other-Audio-Is-Playing-During-App-Launch" class="headerlink" title="1.7 Checking Whether Other Audio Is Playing During App Launch"></a>1.7 Checking Whether Other Audio Is Playing During App Launch</h3><p>当用户启动APP的时候，或许设备正在播放音频。例如：当你启动应用时，设备音乐播放器在播放歌曲或浏览器在播放流媒体音频。如果你的应用是游戏，这种情况很明显。很多游戏有一个音乐声轨和一个音效轨道。在这种情况下，<code>Sound in iOS Human Interface Guidelines</code> 建议你音乐和游戏音效一起播放。检查<code>otherAudioPlaying</code>属性判断在你的应用启动时是否有其他音频正在播放。如果有其他音频正在播放，使你游戏应用的音乐声轨静音并且设置<code>AVAudioSessionCategorySoloAmbient</code>category。</p>
<h3 id="1-8-Working-with-Inter-App-Audio"><a href="#1-8-Working-with-Inter-App-Audio" class="headerlink" title="1.8 Working with Inter-App Audio"></a>1.8 Working with Inter-App Audio</h3><p>在最基本的形式下，跨应用音频允许一个APP（节点APP）发送输出它的音频到另外一个APP（主APP）。也有可能是由主APP发送音频到节点APP，让节点APP来处理音频并返回结果给主APP。主APP需要有一个处于激活状态的<code>audio session</code>，然而节点APP只有在接收主APP输入时才需要一个处于激活状态的<code>audio session</code>。使用下面的指南来设置跨应用音频：</p>
<ul>
<li>为<code>host</code>and<code>node</code>APP的<code>inter-app-audio</code>授权。</li>
<li>为<code>host</code>APP打开<code>UIBackgroundModes</code>的<code>audio</code>开关。</li>
<li>为<code>node</code>APP打开<code>UIBackgroundModes</code>的<code>audio</code>开关，当<code>node</code>APP同时连接到一个<code>inter-app</code>audio host时使用输入或输出线路。</li>
<li>为<code>host</code>和<code>node</code>APP设置<code>AVAudioSessionCategoryOptionMixWithOthers</code>。</li>
<li>当<code>node</code>APP同时连接到一个<code>inter-app</code>audio host时，确保<code>node</code>APP的<code>audio session</code>在接收来自系统的输入（或者发送音频输出）。</li>
</ul>
<hr>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/AudioSession/">AudioSession</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Orchan
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>